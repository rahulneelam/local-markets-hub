{% extends "base.html" %}

{% block title %}Shopping Cart - Marketplace Platform{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h2>Shopping Cart</h2>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
                <li class="breadcrumb-item active" aria-current="page">Cart</li>
            </ol>
        </nav>
    </div>
    
    <div class="col-md-12" id="cart-container">
        <!-- Cart content will be loaded here by JavaScript -->
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading your cart...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Enhanced cart styling */
    .cart-container {
        background: linear-gradient(to right, #f8f9fa, #e9ecef);
        border-radius: 10px;
        box-shadow: 0 6px 15px rgba(0,0,0,0.1);
        overflow: hidden;
        position: relative;
    }
    
    .cart-header {
        background: linear-gradient(45deg, #6a11cb, #2575fc);
        color: white;
        padding: 15px 20px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .cart-item {
        transition: all 0.3s ease;
    }
    
    .cart-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }
    
    .cart-item-img {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 8px;
        transition: transform 0.3s ease;
    }
    
    .cart-item:hover .cart-item-img {
        transform: scale(1.1);
    }
    
    .quantity-control {
        background-color: #f7f7f9;
        border-radius: 50px;
        overflow: hidden;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .quantity-control button {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        transition: all 0.3s;
    }
    
    .quantity-control button:hover {
        background-color: #0d6efd;
        color: white;
    }
    
    .quantity-control input {
        width: 45px;
        text-align: center;
        border: none;
        background: transparent;
    }
    
    .cart-total-card {
        border-radius: 10px;
        box-shadow: 0 6px 15px rgba(0,0,0,0.1);
        position: sticky;
        top: 20px;
    }
    
    .cart-total-header {
        background: linear-gradient(45deg, #11998e, #38ef7d);
        color: white;
        border-radius: 10px 10px 0 0;
    }
    
    .order-form {
        display: none;
        animation: slideDown 0.4s ease;
    }
    
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .btn-place-order {
        background: linear-gradient(45deg, #ff512f, #dd2476);
        border: none;
        font-weight: 600;
        letter-spacing: 0.5px;
        transition: all 0.3s;
    }
    
    .btn-place-order:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(221, 36, 118, 0.4);
    }
    
    .total-price {
        font-size: 1.8rem;
        font-weight: 700;
        color: #5a5a5a;
    }
    
    .cart-empty {
        min-height: 350px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    
    .cart-empty i {
        font-size: 5rem;
        color: #d1d1d1;
        margin-bottom: 1.5rem;
        animation: float 3s ease-in-out infinite;
    }
    
    @keyframes float {
        0% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
        100% { transform: translateY(0px); }
    }
    
    .payment-card {
        border-radius: 10px;
        background-color: #fff;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        margin-top: 30px;
        overflow: hidden;
    }
    
    .payment-header {
        background: linear-gradient(45deg, #3a7bd5, #00d2ff);
        color: white;
        padding: 15px 20px;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
// Functions for cart quantity manipulation
function updateQuantity(productId, newQuantity) {
    if (newQuantity <= 0) {
        removeCartItem(productId);
        return;
    }
    
    updateCartItemQuantity(productId, newQuantity);
    location.reload(); // Refresh the page to show updated cart
}

// Show/hide order form
function showOrderForm() {
    const orderForm = document.getElementById('orderForm');
    if (orderForm) {
        orderForm.style.display = 'block';
        // Smooth scroll to form
        orderForm.scrollIntoView({behavior: 'smooth'});
        // Focus on first input
        setTimeout(() => {
            orderForm.querySelector('input, textarea').focus();
        }, 500);
    }
}

document.addEventListener('DOMContentLoaded', function() {
        // Render cart with server-side data first
        {% if cart_products and cart_products|length > 0 %}
            renderCartFromServerData();
        {% else %}
            // If no server-side data, attempt to render from client side
            renderCartFromClientData();
        {% endif %}
        
        // Function to render cart from server data
        function renderCartFromServerData() {
            const cartContainer = document.getElementById('cart-container');
            
            // Create a card for the cart products with enhanced styling
            let html = `
                <div class="row">
                    <div class="col-lg-8">
                        <div class="cart-container mb-4">
                            <div class="cart-header">
                                <h4 class="mb-0"><i class="bi bi-cart3 me-2"></i> Your Shopping Cart ({{ cart_products|length }} items)</h4>
                            </div>
                            <div class="p-0">
                                {% if cart_products %}
                                    <div class="table-responsive">
                                        <table class="table table-hover mb-0">
                                            <thead>
                                                <tr>
                                                    <th>Product</th>
                                                    <th>Price</th>
                                                    <th>Quantity</th>
                                                    <th>Subtotal</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for item in cart_products %}
                                                <tr class="cart-item">
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            {% if item.product.image_url %}
                                                                <img src="{{ item.product.image_url }}" class="cart-item-img rounded me-3">
                                                            {% else %}
                                                                <div class="cart-item-img bg-light rounded me-3 d-flex align-items-center justify-content-center">
                                                                    <i class="bi bi-box text-secondary"></i>
                                                                </div>
                                                            {% endif %}
                                                            <div>
                                                                <h6 class="mb-0">{{ item.product.name }}</h6>
                                                                <small class="text-muted">{{ item.product.category or 'Uncategorized' }}</small>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td class="fw-medium">${{ "%.2f"|format(item.product.price) }}</td>
                                                    <td>
                                                        <form action="{{ url_for('update_cart', product_id=item.product.id) }}" method="POST" class="d-flex align-items-center">
                                                            <div class="quantity-control d-flex align-items-center">
                                                                <button type="button" class="btn btn-outline-secondary" onclick="this.nextElementSibling.stepDown(); this.nextElementSibling.dispatchEvent(new Event('change'));">
                                                                    <i class="bi bi-dash"></i>
                                                                </button>
                                                                <input type="number" name="quantity" class="form-control text-center" value="{{ item.quantity }}" min="1" max="{{ item.product.stock }}">
                                                                <button type="button" class="btn btn-outline-secondary" onclick="this.previousElementSibling.stepUp(); this.previousElementSibling.dispatchEvent(new Event('change'));">
                                                                    <i class="bi bi-plus"></i>
                                                                </button>
                                                            </div>
                                                            <button type="submit" class="btn btn-sm btn-outline-primary ms-2">
                                                                <i class="bi bi-arrow-repeat"></i>
                                                            </button>
                                                        </form>
                                                    </td>
                                                    <td class="fw-bold">${{ "%.2f"|format(item.subtotal) }}</td>
                                                    <td>
                                                        <form action="{{ url_for('update_cart', product_id=item.product.id) }}" method="POST">
                                                            <input type="hidden" name="quantity" value="0">
                                                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                                                <i class="bi bi-trash"></i> Remove
                                                            </button>
                                                        </form>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Order Form - Hidden by default, shown when Place Order is clicked -->
                        <div id="orderForm" class="payment-card order-form mb-4">
                            <div class="payment-header">
                                <h4 class="mb-0"><i class="bi bi-credit-card me-2"></i> Complete Your Order</h4>
                            </div>
                            <div class="card-body">
                                <form action="{{ url_for('checkout') }}" method="POST">
                                    <input type="hidden" name="shop_id" value="{{ cart.shop_id }}">
                                    
                                    <div class="mb-3">
                                        <label for="address" class="form-label"><i class="bi bi-geo-alt me-1"></i> Shipping Address</label>
                                        <textarea class="form-control" id="address" name="address" rows="2" required placeholder="Enter your complete delivery address"></textarea>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="phone" class="form-label"><i class="bi bi-telephone me-1"></i> Phone Number</label>
                                        <input type="tel" class="form-control" id="phone" name="phone" required placeholder="Enter your contact number">
                                    </div>
                                    
                                    <div class="mb-4">
                                        <label class="form-label"><i class="bi bi-wallet2 me-1"></i> Payment Method</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="payment_method" id="payment-cod" value="cod" checked>
                                            <label class="form-check-label" for="payment-cod">
                                                Cash on Delivery (Pay when you receive)
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <button type="submit" class="btn btn-lg btn-place-order w-100">
                                        <i class="bi bi-bag-check-fill me-2"></i> Place Order Now
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-4">
                        <div class="cart-total-card mb-4 sticky-top">
                            <div class="cart-total-header p-3">
                                <h5 class="mb-0"><i class="bi bi-receipt me-2"></i> Order Summary</h5>
                            </div>
                            <div class="card-body">
                                {% if shop %}
                                <div class="shop-info mb-3">
                                    <h6 class="border-bottom pb-2 mb-2"><i class="bi bi-shop me-2"></i> {{ shop.name }}</h6>
                                    <div class="small text-muted">
                                        {% if shop.address %}<div><i class="bi bi-geo me-1"></i> {{ shop.address }}</div>{% endif %}
                                        {% if shop.phone %}<div><i class="bi bi-telephone me-1"></i> {{ shop.phone }}</div>{% endif %}
                                    </div>
                                </div>
                                {% endif %}
                            
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Subtotal:</span>
                                    <span>${{ "%.2f"|format(cart.total) }}</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Shipping:</span>
                                    <span>Free</span>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between mb-4 align-items-center">
                                    <span>Total:</span>
                                    <span class="total-price">${{ "%.2f"|format(cart.total) }}</span>
                                </div>
                                
                                <form action="{{ url_for('clear_cart') }}" method="POST" class="mb-3">
                                    <button type="submit" class="btn btn-outline-danger mb-3 w-100">
                                        <i class="bi bi-cart-x me-1"></i> Clear Cart
                                    </button>
                                </form>
                                
                                <button type="button" class="btn btn-primary w-100 mb-3" onclick="showOrderForm()">
                                    <i class="bi bi-bag-check me-1"></i> Place Order
                                </button>
                                
                                <div class="mt-3 small text-muted">
                                    <p><i class="bi bi-info-circle me-1"></i> When you place an order, the shop owner will prepare your items for pickup. No payment processing is needed at this point.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            cartContainer.innerHTML = html;
        }
        
        // Function to render cart from client data
        function renderCartFromClientData() {
            const cartContainer = document.getElementById('cart-container');
            const cart = getCart();
            
            if (!cart || !cart.items || cart.items.length === 0) {
                cartContainer.innerHTML = `
                    <div class="card cart-empty">
                        <div class="card-body text-center py-5">
                            <i class="bi bi-cart-x display-1 text-muted mb-3"></i>
                            <h3>Your Shopping Cart is Empty</h3>
                            <p class="lead text-muted">Looks like you haven't added anything to your cart yet.</p>
                            <a href="{{ url_for('index') }}" class="btn btn-primary mt-3 btn-lg">
                                <i class="bi bi-shop me-2"></i> Start Shopping
                            </a>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Create a card for the cart items from client data with enhanced styling
            let html = `
                <div class="row">
                    <div class="col-lg-8">
                        <div class="cart-container mb-4">
                            <div class="cart-header">
                                <h4 class="mb-0"><i class="bi bi-cart3 me-2"></i> Your Shopping Cart (${cart.items.length} items)</h4>
                            </div>
                            <div class="p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead>
                                            <tr>
                                                <th>Product</th>
                                                <th>Price</th>
                                                <th>Quantity</th>
                                                <th>Subtotal</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>`;
            
            cart.items.forEach(item => {
                const subtotal = (item.price * item.quantity).toFixed(2);
                html += `
                    <tr class="cart-item">
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="cart-item-img bg-light rounded me-3 d-flex align-items-center justify-content-center">
                                    <i class="bi bi-box text-secondary"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0">${item.name}</h6>
                                </div>
                            </div>
                        </td>
                        <td class="fw-medium">$${item.price.toFixed(2)}</td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="quantity-control d-flex align-items-center">
                                    <button type="button" class="btn btn-outline-secondary" onclick="updateQuantity('${item.product_id}', ${item.quantity-1})">
                                        <i class="bi bi-dash"></i>
                                    </button>
                                    <input type="number" class="form-control text-center" value="${item.quantity}" min="1" readOnly>
                                    <button type="button" class="btn btn-outline-secondary" onclick="updateQuantity('${item.product_id}', ${item.quantity+1})">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </td>
                        <td class="fw-bold">$${subtotal}</td>
                        <td>
                            <button onclick="removeCartItem('${item.product_id}')" class="btn btn-sm btn-outline-danger">
                                <i class="bi bi-trash"></i> Remove
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Order Form - Hidden by default, shown when Place Order is clicked -->
                <div id="orderForm" class="payment-card order-form mb-4">
                    <div class="payment-header">
                        <h4 class="mb-0"><i class="bi bi-credit-card me-2"></i> Complete Your Order</h4>
                    </div>
                    <div class="card-body">
                        <form action="{{ url_for('checkout') }}" method="POST">
                            <input type="hidden" name="shop_id" value="${cart.shopId || ''}">
                            
                            <div class="mb-3">
                                <label for="address" class="form-label"><i class="bi bi-geo-alt me-1"></i> Shipping Address</label>
                                <textarea class="form-control" id="address" name="address" rows="2" required placeholder="Enter your complete delivery address"></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label for="phone" class="form-label"><i class="bi bi-telephone me-1"></i> Phone Number</label>
                                <input type="tel" class="form-control" id="phone" name="phone" required placeholder="Enter your contact number">
                            </div>
                            
                            <div class="mb-4">
                                <label class="form-label"><i class="bi bi-wallet2 me-1"></i> Payment Method</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="payment_method" id="payment-cod" value="cod" checked>
                                    <label class="form-check-label" for="payment-cod">
                                        Cash on Delivery (Pay when you receive)
                                    </label>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-lg btn-place-order w-100">
                                <i class="bi bi-bag-check-fill me-2"></i> Place Order Now
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="cart-total-card mb-4 sticky-top">
                    <div class="cart-total-header p-3">
                        <h5 class="mb-0"><i class="bi bi-receipt me-2"></i> Order Summary</h5>
                    </div>
                    <div class="card-body">                    
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal:</span>
                            <span>$${cart.total.toFixed(2)}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Shipping:</span>
                            <span>Free</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between mb-4 align-items-center">
                            <span>Total:</span>
                            <span class="total-price">$${cart.total.toFixed(2)}</span>
                        </div>
                        
                        <button onclick="clearCart()" class="btn btn-outline-danger mb-3 w-100">
                            <i class="bi bi-cart-x me-1"></i> Clear Cart
                        </button>
                        
                        <button type="button" class="btn btn-primary w-100 mb-3" onclick="showOrderForm()">
                            <i class="bi bi-bag-check me-1"></i> Place Order
                        </button>
                        
                        <div class="mt-3 small text-muted">
                            <p><i class="bi bi-info-circle me-1"></i> When you place an order, the shop owner will prepare your items for pickup. No payment processing is needed at this point.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>`;
                
            cartContainer.innerHTML = html;
            
            // Add event listener for the clear cart button
            document.querySelector('button[onclick="clearCart()"]').addEventListener('click', function(e) {
                e.preventDefault();
                // Send request to clear cart
                fetch("{{ url_for('clear_cart') }}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => {
                    if (response.ok) {
                        // Clear local cart storage
                        localStorage.removeItem('cart');
                        // Refresh page to show empty cart
                        window.location.reload();
                    }
                });
            });
            
            // Fetch shop details if we have a shop ID
            let shopName = 'Shop';
            if (cart.shopId) {
                // In a real implementation, you'd fetch shop details from the server
                // For now, we'll just use a placeholder
                shopName = 'Shop #' + cart.shopId;
            }
            
            // Render cart with items
            let itemsHtml = '';
            
            cart.items.forEach(item => {
                const subtotal = (item.price * item.quantity).toFixed(2);
                
                itemsHtml += `
                    <div class="card mb-3 cart-item" data-product-id="${item.productId}">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <h5 class="card-title mb-1">${item.name}</h5>
                                    <p class="card-text text-muted small">Product ID: ${item.productId}</p>
                                </div>
                                <div class="col-md-2">
                                    <div class="quantity-control">
                                        <button type="button" class="btn btn-outline-secondary btn-sm btn-decrease">
                                            <i class="bi bi-dash"></i>
                                        </button>
                                        <input type="number" class="form-control-plaintext quantity-input" value="${item.quantity}" min="1" max="99" readonly>
                                        <button type="button" class="btn btn-outline-secondary btn-sm btn-increase">
                                            <i class="bi bi-plus"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-2 text-md-end">
                                    <p class="card-text fw-bold">$${item.price.toFixed(2)}</p>
                                    <p class="card-text text-muted small">Subtotal: $${subtotal}</p>
                                </div>
                                <div class="col-md-2 text-md-end">
                                    <button type="button" class="btn btn-link text-muted btn-remove">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            cartContainer.innerHTML = `
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Your Items from ${shopName}</h5>
                        <button type="button" class="btn btn-outline-danger btn-sm clear-cart-btn">
                            <i class="bi bi-x-circle me-1"></i> Clear Cart
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="cart-items">
                            ${itemsHtml}
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-8">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">Shipping Information</h5>
                            </div>
                            <div class="card-body">
                                <form action="{{ url_for('checkout') }}" method="POST">
                                    <input type="hidden" name="shop_id" value="{{ session.cart.shop_id }}">
                                    
                                    <div class="mb-3">
                                        <label for="address" class="form-label">Shipping Address</label>
                                        <textarea class="form-control" id="address" name="address" rows="3" required></textarea>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="phone" class="form-label">Phone Number</label>
                                        <input type="tel" class="form-control" id="phone" name="phone" required>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Payment Method</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="payment_method" id="payment-cod" value="cod" checked>
                                            <label class="form-check-label" for="payment-cod">
                                                Cash on Delivery
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="d-grid gap-2 mt-4">
                                        <button type="submit" class="btn btn-primary btn-lg">
                                            <i class="bi bi-bag-check me-1"></i> Place Order
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Order Summary</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Subtotal (${cart.items.reduce((sum, item) => sum + item.quantity, 0)} items):</span>
                                    <span>$${cart.total.toFixed(2)}</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Shipping Fee:</span>
                                    <span>$0.00</span>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between mb-2 fw-bold">
                                    <span>Total:</span>
                                    <span class="text-primary">$${cart.total.toFixed(2)}</span>
                                </div>
                                
                                <div class="alert alert-info mt-3 mb-0">
                                    <i class="bi bi-info-circle me-2"></i> This is a demonstration site. No real payments will be processed.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Add event listeners to the newly created elements
            setupCartEventListeners();
        }
        
        // Setup event listeners for cart interactions
        function setupCartEventListeners() {
            // Clear cart button
            const clearCartBtn = document.querySelector('.clear-cart-btn');
            if (clearCartBtn) {
                clearCartBtn.addEventListener('click', function() {
                    if (confirm('Are you sure you want to clear your cart?')) {
                        clearCart();
                        renderCart();
                    }
                });
            }
            
            // Item quantity decrease buttons
            document.querySelectorAll('.btn-decrease').forEach(button => {
                button.addEventListener('click', function() {
                    const cartItem = this.closest('.cart-item');
                    const productId = cartItem.getAttribute('data-product-id');
                    const quantityInput = cartItem.querySelector('.quantity-input');
                    const currentQuantity = parseInt(quantityInput.value, 10);
                    
                    if (currentQuantity > 1) {
                        // Update quantity in UI
                        quantityInput.value = currentQuantity - 1;
                        
                        // Update quantity in cart
                        updateCartItemQuantity(productId, currentQuantity - 1);
                        
                        // Re-render cart to update totals
                        renderCart();
                    }
                });
            });
            
            // Item quantity increase buttons
            document.querySelectorAll('.btn-increase').forEach(button => {
                button.addEventListener('click', function() {
                    const cartItem = this.closest('.cart-item');
                    const productId = cartItem.getAttribute('data-product-id');
                    const quantityInput = cartItem.querySelector('.quantity-input');
                    const currentQuantity = parseInt(quantityInput.value, 10);
                    
                    // Update quantity in UI
                    quantityInput.value = currentQuantity + 1;
                    
                    // Update quantity in cart
                    updateCartItemQuantity(productId, currentQuantity + 1);
                    
                    // Re-render cart to update totals
                    renderCart();
                });
            });
            
            // Item remove buttons
            document.querySelectorAll('.btn-remove').forEach(button => {
                button.addEventListener('click', function() {
                    const cartItem = this.closest('.cart-item');
                    const productId = cartItem.getAttribute('data-product-id');
                    
                    // Remove item from cart
                    removeCartItem(productId);
                    
                    // Re-render cart
                    renderCart();
                });
            });
            
            // Checkout form
            const checkoutForm = document.getElementById('checkout-form');
            if (checkoutForm) {
                checkoutForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const formData = new FormData(this);
                    const cart = getCart();
                    
                    // Add cart items to form data
                    formData.append('cart_items', JSON.stringify(cart.items));
                    formData.append('cart_total', cart.total);
                    
                    // Show loading state
                    const submitBtn = this.querySelector('[type="submit"]');
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
                    
                    // Submit form
                    fetch(this.action, {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Clear cart
                            clearCart();
                            
                            // Redirect to order confirmation
                            window.location.href = data.redirect;
                        } else {
                            // Show error
                            alert(data.message || 'An error occurred during checkout. Please try again.');
                            
                            // Reset button
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = 'Proceed to Checkout';
                        }
                    })
                    .catch(error => {
                        console.error('Error during checkout:', error);
                        alert('A network error occurred during checkout. Please try again.');
                        
                        // Reset button
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = 'Proceed to Checkout';
                    });
                });
            }
        }
    });
</script>
{% endblock %}